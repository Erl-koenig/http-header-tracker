<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Header Analysis Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: #0a0e27;
        color: #e4e4e7;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: #1a1d2e;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        padding: 40px;
        border: 1px solid #2a2d3e;
      }

      h1 {
        color: #3b82f6;
        margin-bottom: 10px;
        font-size: 2.5em;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .section {
        margin-bottom: 40px;
      }

      .section-title {
        font-size: 1.5em;
        color: #f1f5f9;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #2563eb;
      }

      /* Data Import Section */
      .import-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .import-box {
        border: 2px dashed #2563eb;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #0f172a;
      }

      .import-box:hover {
        background: #1e293b;
        border-color: #3b82f6;
      }

      .import-box h3 {
        margin-bottom: 10px;
        color: #60a5fa;
      }

      .btn {
        background: #2563eb;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.2s ease;
        margin: 5px;
      }

      .btn:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      }

      .btn:active {
        transform: translateY(0);
      }

      /* Controls */
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        padding: 20px;
        background: #0f172a;
        border-radius: 8px;
        border: 1px solid #1e293b;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .control-group label {
        font-weight: 600;
        color: #cbd5e1;
        font-size: 0.9em;
      }

      select,
      input[type="number"] {
        padding: 8px 12px;
        border: 1px solid #334155;
        border-radius: 6px;
        font-size: 1em;
        transition: border-color 0.3s ease;
        background: #1e293b;
        color: #e2e8f0;
      }

      select:focus,
      input[type="number"]:focus {
        outline: none;
        border-color: #3b82f6;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #0f172a;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #1e293b;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .stat-card .value {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
        color: #3b82f6;
      }

      .stat-card .label {
        font-size: 0.9em;
        color: #94a3b8;
      }

      /* Tables */
      .table-container {
        margin-bottom: 30px;
        border-radius: 8px;
        border: 1px solid #1e293b;
        background: #0f172a;
        max-height: 600px;
        overflow-y: auto;
        overflow-x: auto;
      }

      table {
        width: 100%;
        background: #0f172a;
        border-collapse: collapse;
      }

      thead {
        background: #1e293b;
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
        color: #e2e8f0;
      }

      th:hover {
        background: #334155;
      }

      th::after {
        content: " ‚áÖ";
        opacity: 0.5;
        font-size: 0.8em;
      }

      td {
        padding: 12px 15px;
        border-bottom: 1px solid #1e293b;
        color: #cbd5e1;
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      tbody tr:hover {
        background: #1e293b;
      }

      tbody tr:nth-child(even) {
        background: #0a0f1e;
      }

      tbody tr:nth-child(even):hover {
        background: #1e293b;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 600;
      }

      .badge-request {
        background: #1e3a8a;
        color: #93c5fd;
      }

      .badge-response {
        background: #581c87;
        color: #d8b4fe;
      }

      .hidden {
        display: none;
      }

      .alert {
        padding: 15px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .alert-info {
        background: #1e3a8a;
        color: #bfdbfe;
        border-left: 4px solid #3b82f6;
      }

      .alert-success {
        background: #14532d;
        color: #bbf7d0;
        border-left: 4px solid #22c55e;
      }

      .alert-warning {
        background: #78350f;
        color: #fef3c7;
        border-left: 4px solid #eab308;
      }

      /* Remove button */
      .btn-remove {
        background: #dc2626;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .btn-remove:hover {
        background: #b91c1c;
        transform: scale(1.1);
      }

      /* Ignored entries panel */
      .ignored-panel {
        background: #0f172a;
        border: 1px solid #1e293b;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .ignored-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .ignored-item {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #94a3b8;
      }

      .ignored-item button {
        background: none;
        border: none;
        color: #f87171;
        cursor: pointer;
        font-size: 1.1em;
        padding: 0;
        line-height: 1;
      }

      .ignored-item button:hover {
        color: #dc2626;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Header Analysis</h1>
      <!-- Data Import Section -->
      <div class="section">
        <h2 class="section-title">1. Import Data</h2>
        <div class="import-options">
          <div
            class="import-box"
            onclick="document.getElementById('fileInput').click()"
          >
            <h3>üìÅ Upload JSON File</h3>
            <p>Import data from a file</p>
            <input
              type="file"
              id="fileInput"
              accept=".json"
              style="display: none"
            />
          </div>
          <div
            class="import-box"
            onclick="document.getElementById('serverLoadBtn').click()"
          >
            <h3>üåê Load from Server</h3>
            <p>Use current server stats.json</p>
            <button id="serverLoadBtn" class="btn">Load Server Data</button>
          </div>
        </div>
        <div id="loadStatus"></div>
        <div id="dataSourceInfo" style="margin-top: 15px"></div>
        <div id="currentDataInfo" style="margin-top: 15px"></div>
      </div>

      <!-- Configuration -->
      <div class="section">
        <h2 class="section-title">2. Configuration</h2>

        <!-- Ignored Entries Panel -->
        <div id="ignoredPanel" class="ignored-panel hidden">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <strong style="color: #f87171"
              >Ignored Entries (<span id="ignoredCount">0</span>)</strong
            >
            <button
              class="btn-remove"
              onclick="clearAllIgnored()"
              style="background: #0891b2"
            >
              Clear All
            </button>
          </div>
          <div id="ignoredList" class="ignored-list"></div>
        </div>

        <div class="controls">
          <div class="control-group">
            <label>Table View</label>
            <select id="tableView" onchange="updateAnalysis()">
              <option value="combined">Combined (Request + Response)</option>
              <option value="split">Split by Type</option>
            </select>
          </div>
          <div class="control-group">
            <label>Min Occurrences</label>
            <input
              type="number"
              id="minCount"
              value="1"
              min="1"
              onchange="updateAnalysis()"
            />
          </div>
        </div>
      </div>

      <!-- Statistics Overview -->
      <div class="section hidden" id="statsSection">
        <h2 class="section-title">3. Overview Statistics</h2>
        <div class="stats-grid" id="statsGrid"></div>
      </div>

      <!-- Tables -->
      <div class="section hidden" id="tablesSection">
        <h2 class="section-title">4. Detailed Analysis Tables</h2>

        <!-- Combined View -->
        <div id="combinedView">
          <div id="completePairsSection">
            <h3 style="margin-bottom: 15px; color: #667eea">
              Complete Key-Value Pairs
            </h3>
            <div class="table-container">
              <table id="completePairsTable">
                <thead>
                  <tr>
                    <th
                      onclick="sortTable('completePairsTable', 0)"
                      style="width: 12%"
                    >
                      Type
                    </th>
                    <th
                      onclick="sortTable('completePairsTable', 1)"
                      style="width: 28%"
                    >
                      Header Name
                    </th>
                    <th
                      onclick="sortTable('completePairsTable', 2)"
                      style="width: 40%"
                    >
                      Value
                    </th>
                    <th
                      onclick="sortTable('completePairsTable', 3)"
                      style="width: 15%"
                    >
                      Occurrences
                    </th>
                    <th style="width: 5%">Remove</th>
                  </tr>
                </thead>
                <tbody id="completePairsBody"></tbody>
              </table>
            </div>
          </div>

          <div id="nameOnlySection" style="margin-top: 40px">
            <h3 style="margin-bottom: 15px; color: #667eea">
              Header Names Only
            </h3>
            <div class="table-container">
              <table id="nameOnlyTable">
                <thead>
                  <tr>
                    <th
                      onclick="sortTable('nameOnlyTable', 0)"
                      style="width: 12%"
                    >
                      Type
                    </th>
                    <th
                      onclick="sortTable('nameOnlyTable', 1)"
                      style="width: 45%"
                    >
                      Header Name
                    </th>
                    <th
                      onclick="sortTable('nameOnlyTable', 2)"
                      style="width: 18%"
                    >
                      Occurrences
                    </th>
                    <th
                      onclick="sortTable('nameOnlyTable', 3)"
                      style="width: 20%"
                    >
                      Unique Values
                    </th>
                    <th style="width: 5%">Remove</th>
                  </tr>
                </thead>
                <tbody id="nameOnlyBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Split View (Request/Response Separate) -->
        <div id="splitView" class="hidden">
          <!-- Request Tables -->
          <h3 style="margin-bottom: 20px; color: #22c55e; font-size: 1.8em">
            üì§ Request Headers
          </h3>

          <div style="margin-bottom: 60px">
            <h4 style="margin-bottom: 15px; color: #667eea">
              Complete Key-Value Pairs
            </h4>
            <div class="table-container">
              <table id="requestCompletePairsTable">
                <thead>
                  <tr>
                    <th
                      onclick="sortTable('requestCompletePairsTable', 0)"
                      style="width: 35%"
                    >
                      Header Name
                    </th>
                    <th
                      onclick="sortTable('requestCompletePairsTable', 1)"
                      style="width: 50%"
                    >
                      Value
                    </th>
                    <th
                      onclick="sortTable('requestCompletePairsTable', 2)"
                      style="width: 10%"
                    >
                      Occurrences
                    </th>
                    <th style="width: 5%">Remove</th>
                  </tr>
                </thead>
                <tbody id="requestCompletePairsBody"></tbody>
              </table>
            </div>

            <h4 style="margin: 40px 0 15px 0; color: #667eea">
              Header Names Only
            </h4>
            <div class="table-container">
              <table id="requestNameOnlyTable">
                <thead>
                  <tr>
                    <th
                      onclick="sortTable('requestNameOnlyTable', 0)"
                      style="width: 55%"
                    >
                      Header Name
                    </th>
                    <th
                      onclick="sortTable('requestNameOnlyTable', 1)"
                      style="width: 20%"
                    >
                      Occurrences
                    </th>
                    <th
                      onclick="sortTable('requestNameOnlyTable', 2)"
                      style="width: 20%"
                    >
                      Unique Values
                    </th>
                    <th style="width: 5%">Remove</th>
                  </tr>
                </thead>
                <tbody id="requestNameOnlyBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Response Tables -->
          <h3 style="margin-bottom: 20px; color: #a78bfa; font-size: 1.8em">
            üì• Response Headers
          </h3>

          <div>
            <h4 style="margin-bottom: 15px; color: #667eea">
              Complete Key-Value Pairs
            </h4>
            <div class="table-container">
              <table id="responseCompletePairsTable">
                <thead>
                  <tr>
                    <th
                      onclick="sortTable('responseCompletePairsTable', 0)"
                      style="width: 35%"
                    >
                      Header Name
                    </th>
                    <th
                      onclick="sortTable('responseCompletePairsTable', 1)"
                      style="width: 50%"
                    >
                      Value
                    </th>
                    <th
                      onclick="sortTable('responseCompletePairsTable', 2)"
                      style="width: 10%"
                    >
                      Occurrences
                    </th>
                    <th style="width: 5%">Remove</th>
                  </tr>
                </thead>
                <tbody id="responseCompletePairsBody"></tbody>
              </table>
            </div>

            <h4 style="margin: 40px 0 15px 0; color: #667eea">
              Header Names Only
            </h4>
            <div class="table-container">
              <table id="responseNameOnlyTable">
                <thead>
                  <tr>
                    <th
                      onclick="sortTable('responseNameOnlyTable', 0)"
                      style="width: 55%"
                    >
                      Header Name
                    </th>
                    <th
                      onclick="sortTable('responseNameOnlyTable', 1)"
                      style="width: 20%"
                    >
                      Occurrences
                    </th>
                    <th
                      onclick="sortTable('responseNameOnlyTable', 2)"
                      style="width: 20%"
                    >
                      Unique Values
                    </th>
                    <th style="width: 5%">Remove</th>
                  </tr>
                </thead>
                <tbody id="responseNameOnlyBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Export Section -->
      <div class="section hidden" id="exportSection">
        <h2 class="section-title">5. Export</h2>
        <button
          class="btn"
          onclick="exportJson()"
          style="font-size: 1.1em; padding: 16px 32px"
        >
          Export Data (stats.json)
        </button>
      </div>
    </div>

    <script>
      let rawData = [];
      let dataSource = null; // Track which source data came from
      let ignoredEntries = new Set(); // Set of keys to ignore: "type::name::value"
      let analysisResults = {
        completePairs: [],
        nameOnly: [],
        totalOccurrences: 0,
        uniqueHeaders: 0,
      };

      // File upload handler
      document
        .getElementById("fileInput")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          showStatus(`Loading file...`, "info");

          try {
            const text = await file.text();
            const data = JSON.parse(text);
            loadData(data, file.name);
          } catch (error) {
            showStatus("Error parsing JSON file: " + error.message, "error");
          }

          // Reset file input
          e.target.value = "";
        });

      // Load from server
      document
        .getElementById("serverLoadBtn")
        .addEventListener("click", async function () {
          try {
            showStatus("Loading data from server...", "info");
            const response = await fetch("/stats");
            if (!response.ok) throw new Error("Failed to fetch server data");
            const data = await response.json();
            loadData(data, "server");
          } catch (error) {
            showStatus("Error loading from server: " + error.message, "error");
          }
        });

      // Main data loading function
      function loadData(data, sourceName = "unknown") {
        // Clear existing data first
        rawData = [];
        dataSource = null;
        ignoredEntries.clear();

        // Handle both array format and object format
        if (Array.isArray(data)) {
          rawData = data;
        } else if (typeof data === "object") {
          // Convert object to array
          rawData = Object.values(data);
        } else {
          showStatus("Invalid data format", "error");
          return;
        }

        dataSource = sourceName;

        showStatus(
          `Successfully loaded ${rawData.length} entries from ${sourceName}`,
          "success",
        );
        updateDataSourceInfo();
        updateCurrentDataInfo();

        // Show or hide sections based on whether we have data
        if (rawData.length > 0) {
          ["statsSection", "tablesSection", "exportSection"].forEach((id) => {
            document.getElementById(id).classList.remove("hidden");
          });
          updateAnalysis();
        } else {
          // Hide sections if no data
          ["statsSection", "tablesSection", "exportSection"].forEach((id) => {
            document.getElementById(id).classList.add("hidden");
          });
        }
      }

      // Update data source info display
      function updateDataSourceInfo() {
        const sourceInfo = document.getElementById("dataSourceInfo");
        if (dataSource) {
          sourceInfo.innerHTML = `
            <div class="alert alert-info">
              <strong>Data Source:</strong> ${escapeHtml(dataSource)}
            </div>
          `;
        } else {
          sourceInfo.innerHTML = "";
        }
      }

      // Update current data info display
      function updateCurrentDataInfo() {
        const info = document.getElementById("currentDataInfo");
        if (rawData.length > 0) {
          info.innerHTML = `
          <div class="alert alert-info">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span><strong>${rawData.length}</strong> entries loaded</span>
              <button class="btn-remove" onclick="clearAllData()" style="background: #0891b2;">Clear Data</button>
            </div>
          </div>
        `;
        } else {
          info.innerHTML = "";
        }
      }

      // Clear all loaded data
      function clearAllData() {
        if (confirm("Are you sure you want to clear all loaded data?")) {
          rawData = [];
          dataSource = null;
          ignoredEntries.clear();

          // Hide all sections
          ["statsSection", "tablesSection", "exportSection"].forEach((id) => {
            document.getElementById(id).classList.add("hidden");
          });

          updateDataSourceInfo();
          updateCurrentDataInfo();
          updateIgnoredPanel();
          showStatus("All data cleared", "success");
        }
      }

      // Update analysis based on current settings
      function updateAnalysis() {
        if (rawData.length === 0) return;

        const minCount =
          parseInt(document.getElementById("minCount").value) || 1;

        // Filter data
        let filteredData = rawData.filter((item) => {
          // Check if entry is ignored
          const key = `${item.type}::${item.name.toLowerCase()}::${item.value || ""}`;
          if (ignoredEntries.has(key)) return false;

          if (item.count < minCount) return false;
          return true;
        });

        // Calculate complete pairs (sorted by count)
        const completePairs = filteredData
          .map((item) => ({
            name: item.name,
            value: item.value || "",
            type: item.type,
            count: item.count,
          }))
          .sort((a, b) => b.count - a.count);

        // Calculate name-only (aggregate by header name)
        const nameMap = {};
        filteredData.forEach((item) => {
          const key = `${item.type}::${item.name.toLowerCase()}`;
          if (!nameMap[key]) {
            nameMap[key] = {
              name: item.name,
              type: item.type,
              count: 0,
              uniqueValues: new Set(),
            };
          }
          nameMap[key].count += item.count;
          if (item.value) {
            nameMap[key].uniqueValues.add(item.value);
          }
        });

        const nameOnly = Object.values(nameMap)
          .map((item) => ({
            ...item,
            uniqueValues: item.uniqueValues.size,
          }))
          .sort((a, b) => b.count - a.count);

        // Calculate statistics
        const totalOccurrences = filteredData.reduce(
          (sum, item) => sum + item.count,
          0,
        );
        const uniqueHeaders = new Set(
          filteredData.map((item) => item.name.toLowerCase()),
        ).size;

        analysisResults = {
          completePairs,
          nameOnly,
          totalOccurrences,
          uniqueHeaders,
          filteredData,
        };

        // Update all visualizations
        updateStatsCards();
        updateTables();

        // Toggle table view
        const tableView = document.getElementById("tableView").value;
        const combinedView = document.getElementById("combinedView");
        const splitView = document.getElementById("splitView");

        if (tableView === "split") {
          combinedView.classList.add("hidden");
          splitView.classList.remove("hidden");
        } else {
          combinedView.classList.remove("hidden");
          splitView.classList.add("hidden");
        }
      }

      // Update stats cards
      function updateStatsCards() {
        const { totalOccurrences } = analysisResults;

        const stats = [
          {
            label: "Total Occurrences",
            value: totalOccurrences.toLocaleString(),
          },
          { label: "Unique Headers", value: analysisResults.uniqueHeaders },
        ];

        document.getElementById("statsGrid").innerHTML = stats
          .map(
            (stat) => `
        <div class="stat-card">
          <div class="value">${stat.value}</div>
          <div class="label">${stat.label}</div>
        </div>
      `,
          )
          .join("");
      }

      // Update tables
      function updateTables() {
        const { completePairs, nameOnly } = analysisResults;

        // Complete Pairs Table
        const completePairsBody = document.getElementById("completePairsBody");
        completePairsBody.innerHTML = completePairs
          .map((pair) => {
            const key = `${pair.type}::${pair.name.toLowerCase()}::${pair.value || ""}`;
            const escapedKey = escapeHtml(key);

            return `
          <tr>
            <td><span class="badge badge-${pair.type}">${pair.type}</span></td>
            <td title="${escapeHtml(pair.name)}"><strong>${escapeHtml(pair.name)}</strong></td>
            <td title="${escapeHtml(pair.value)}">${escapeHtml(pair.value)}</td>
            <td>${pair.count.toLocaleString()}</td>
            <td>
              <button class="btn-remove" data-key="${escapedKey}" onclick="ignoreEntry(this.getAttribute('data-key'))">
                ‚úï
              </button>
            </td>
          </tr>
        `;
          })
          .join("");

        // Name-Only Table
        const nameOnlyBody = document.getElementById("nameOnlyBody");
        nameOnlyBody.innerHTML = nameOnly
          .map((item) => {
            const key = `${item.type}::${item.name.toLowerCase()}`;
            const escapedKey = escapeHtml(key);

            return `
          <tr>
            <td><span class="badge badge-${item.type}">${item.type}</span></td>
            <td title="${escapeHtml(item.name)}"><strong>${escapeHtml(item.name)}</strong></td>
            <td>${item.count.toLocaleString()}</td>
            <td>${item.uniqueValues.toLocaleString()}</td>
            <td>
              <button class="btn-remove" data-key="${escapedKey}" onclick="ignoreHeaderName(this.getAttribute('data-key'))">
                ‚úï
              </button>
            </td>
          </tr>
        `;
          })
          .join("");

        // Also populate split view tables
        const tableView = document.getElementById("tableView").value;
        if (tableView === "split") {
          populateSplitViewTables(completePairs, nameOnly);
        }
      }

      // Populate split view tables (separate request/response)
      function populateSplitViewTables(completePairs, nameOnly) {
        // Filter request and response complete pairs
        const requestCompletePairs = completePairs.filter(
          (p) => p.type === "request",
        );
        const responseCompletePairs = completePairs.filter(
          (p) => p.type === "response",
        );

        // Filter request and response name-only
        const requestNameOnly = nameOnly.filter((n) => n.type === "request");
        const responseNameOnly = nameOnly.filter((n) => n.type === "response");

        // Render request complete pairs
        const requestCompletePairsBody = document.getElementById(
          "requestCompletePairsBody",
        );
        requestCompletePairsBody.innerHTML = requestCompletePairs
          .map((pair) => {
            const key = `${pair.type}::${pair.name.toLowerCase()}::${pair.value || ""}`;
            const escapedKey = escapeHtml(key);

            return `
            <tr>
              <td title="${escapeHtml(pair.name)}"><strong>${escapeHtml(pair.name)}</strong></td>
              <td title="${escapeHtml(pair.value)}">${escapeHtml(pair.value)}</td>
              <td>${pair.count.toLocaleString()}</td>
              <td>
                <button class="btn-remove" data-key="${escapedKey}" onclick="ignoreEntry(this.getAttribute('data-key'))">‚úï</button>
              </td>
            </tr>
          `;
          })
          .join("");

        // Render response complete pairs
        const responseCompletePairsBody = document.getElementById(
          "responseCompletePairsBody",
        );
        responseCompletePairsBody.innerHTML = responseCompletePairs
          .map((pair) => {
            const key = `${pair.type}::${pair.name.toLowerCase()}::${pair.value || ""}`;
            const escapedKey = escapeHtml(key);

            return `
            <tr>
              <td title="${escapeHtml(pair.name)}"><strong>${escapeHtml(pair.name)}</strong></td>
              <td title="${escapeHtml(pair.value)}">${escapeHtml(pair.value)}</td>
              <td>${pair.count.toLocaleString()}</td>
              <td>
                <button class="btn-remove" data-key="${escapedKey}" onclick="ignoreEntry(this.getAttribute('data-key'))">‚úï</button>
              </td>
            </tr>
          `;
          })
          .join("");

        // Render request name-only
        const requestNameOnlyBody = document.getElementById(
          "requestNameOnlyBody",
        );
        requestNameOnlyBody.innerHTML = requestNameOnly
          .map((item) => {
            const key = `${item.type}::${item.name.toLowerCase()}`;
            const escapedKey = escapeHtml(key);

            return `
            <tr>
              <td title="${escapeHtml(item.name)}"><strong>${escapeHtml(item.name)}</strong></td>
              <td>${item.count.toLocaleString()}</td>
              <td>${item.uniqueValues.toLocaleString()}</td>
              <td>
                <button class="btn-remove" data-key="${escapedKey}" onclick="ignoreHeaderName(this.getAttribute('data-key'))">‚úï</button>
              </td>
            </tr>
          `;
          })
          .join("");

        // Render response name-only
        const responseNameOnlyBody = document.getElementById(
          "responseNameOnlyBody",
        );
        responseNameOnlyBody.innerHTML = responseNameOnly
          .map((item) => {
            const key = `${item.type}::${item.name.toLowerCase()}`;
            const escapedKey = escapeHtml(key);

            return `
            <tr>
              <td title="${escapeHtml(item.name)}"><strong>${escapeHtml(item.name)}</strong></td>
              <td>${item.count.toLocaleString()}</td>
              <td>${item.uniqueValues.toLocaleString()}</td>
              <td>
                <button class="btn-remove" data-key="${escapedKey}" onclick="ignoreHeaderName(this.getAttribute('data-key'))">‚úï</button>
              </td>
            </tr>
          `;
          })
          .join("");
      }

      function exportJson() {
        // Apply the same filters as the analysis
        const minCount =
          parseInt(document.getElementById("minCount").value) || 1;

        // Export data with all filters applied
        const filteredData = rawData.filter((item) => {
          // Check if entry is ignored
          const key = `${item.type}::${item.name.toLowerCase()}::${item.value || ""}`;
          if (ignoredEntries.has(key)) return false;

          // Apply min count filter
          if (item.count < minCount) return false;

          return true;
        });

        // Convert to object format (same as server stats.json)
        const exportData = {};
        filteredData.forEach((item) => {
          const key = `${item.type}::${item.name.toLowerCase()}::${item.value || ""}`;
          exportData[key] = {
            name: item.name,
            value: item.value || "",
            type: item.type,
            count: item.count,
          };
        });

        downloadFile(
          "stats.json",
          JSON.stringify(exportData, null, 2),
          "application/json",
        );

        // Show success message
        alert(`Exported ${filteredData.length} header entries to stats.json`);
      }

      // Helper functions
      function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function showStatus(message, type) {
        const alertClass =
          type === "error"
            ? "alert-warning"
            : type === "success"
              ? "alert-success"
              : "alert-info";
        document.getElementById("loadStatus").innerHTML = `
        <div class="alert ${alertClass}" style="margin-top: 15px;">
          ${escapeHtml(message)}
        </div>
      `;
        setTimeout(() => {
          document.getElementById("loadStatus").innerHTML = "";
        }, 5000);
      }

      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Ignore/Remove entry functions
      function ignoreEntry(key) {
        ignoredEntries.add(key);
        updateIgnoredPanel();
        updateAnalysis();
      }

      function ignoreHeaderName(nameKey) {
        // Ignore all entries with this header name
        const [type, name] = nameKey.split("::");
        rawData.forEach((item) => {
          if (item.type === type && item.name.toLowerCase() === name) {
            const key = `${item.type}::${item.name.toLowerCase()}::${item.value || ""}`;
            ignoredEntries.add(key);
          }
        });
        updateIgnoredPanel();
        updateAnalysis();
      }

      function unignoreEntry(key) {
        ignoredEntries.delete(key);
        updateIgnoredPanel();
        updateAnalysis();
      }

      function clearAllIgnored() {
        if (
          confirm(
            `Are you sure you want to clear all ${ignoredEntries.size} ignored entries?`,
          )
        ) {
          ignoredEntries.clear();
          updateIgnoredPanel();
          updateAnalysis();
        }
      }

      function updateIgnoredPanel() {
        const panel = document.getElementById("ignoredPanel");
        const list = document.getElementById("ignoredList");
        const count = document.getElementById("ignoredCount");

        count.textContent = ignoredEntries.size;

        if (ignoredEntries.size === 0) {
          panel.classList.add("hidden");
          return;
        }

        panel.classList.remove("hidden");

        // Group ignored entries by header name for better display
        const grouped = {};
        ignoredEntries.forEach((key) => {
          const [type, name, value] = key.split("::");
          const groupKey = `${type}::${name}`;
          if (!grouped[groupKey]) {
            grouped[groupKey] = [];
          }
          grouped[groupKey].push({ key, value });
        });

        list.innerHTML = Object.entries(grouped)
          .map(([groupKey, entries]) => {
            const [type, name] = groupKey.split("::");
            const badge =
              type === "request" ? "badge-request" : "badge-response";

            if (entries.length === 1 && entries[0].value) {
              // Single specific value
              const escapedEntryKey = escapeHtml(entries[0].key);
              return `
            <div class="ignored-item">
              <span class="badge ${badge}">${type}</span>
              <strong>${escapeHtml(name)}</strong>: ${escapeHtml(entries[0].value).substring(0, 30)}${entries[0].value.length > 30 ? "..." : ""}
              <button data-key="${escapedEntryKey}" onclick="unignoreEntry(this.getAttribute('data-key'))">‚úï</button>
            </div>
          `;
            } else {
              // Multiple values or header name
              const escapedGroupKey = escapeHtml(groupKey);
              return `
            <div class="ignored-item">
              <span class="badge ${badge}">${type}</span>
              <strong>${escapeHtml(name)}</strong> (${entries.length} ${entries.length === 1 ? "entry" : "entries"})
              <button data-key="${escapedGroupKey}" onclick="unignoreHeaderName(this.getAttribute('data-key'))">‚úï</button>
            </div>
          `;
            }
          })
          .join("");
      }

      function unignoreHeaderName(nameKey) {
        const [type, name] = nameKey.split("::");
        const toRemove = [];
        ignoredEntries.forEach((key) => {
          if (key.startsWith(nameKey + "::") || key === nameKey) {
            toRemove.push(key);
          }
        });
        toRemove.forEach((key) => ignoredEntries.delete(key));
        updateIgnoredPanel();
        updateAnalysis();
      }

      // Track sort state for each table/column
      let sortState = {};

      function sortTable(tableId, columnIndex) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        // Track sort direction for this table+column
        const sortKey = `${tableId}-${columnIndex}`;
        const isAscending = sortState[sortKey] || false;
        sortState[sortKey] = !isAscending;

        rows.sort((a, b) => {
          const aVal = a.children[columnIndex].textContent.trim();
          const bVal = b.children[columnIndex].textContent.trim();

          // Try numeric comparison first
          const aNum = parseFloat(aVal.replace(/[^0-9.-]/g, ""));
          const bNum = parseFloat(bVal.replace(/[^0-9.-]/g, ""));

          let comparison;
          if (!isNaN(aNum) && !isNaN(bNum)) {
            comparison = aNum - bNum;
          } else {
            comparison = aVal.localeCompare(bVal);
          }

          // Toggle between ascending and descending
          return isAscending ? comparison : -comparison;
        });

        tbody.innerHTML = "";
        rows.forEach((row) => tbody.appendChild(row));
      }
    </script>
  </body>
</html>
